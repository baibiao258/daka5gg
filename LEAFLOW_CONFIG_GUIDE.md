# 🚀 Leaflow 配置完整指南

## 📋 前置准备

### ✅ 确认项目状态
- **GitHub仓库**: https://github.com/baibiao258/daka5gg.git
- **Docker镜像**: `ghcr.io/baibiao258/daka5gg:latest` (或具体版本标签)
- **项目功能**: 自动打卡(08:00, 17:00) + 自动日报(19:00)

### 🏗️ 构建状态确认
1. **访问GitHub Actions页面**:
   ```
   https://github.com/baibiao258/daka5gg/actions
   ```

2. **确认构建成功**:
   - ✅ "Build and Push Docker Image" 工作流显示 "Success"
   - ✅ Docker镜像已推送到 GitHub Container Registry
   - ✅ 可在Packages页面看到镜像

---

## 🌐 在Leaflow创建应用

### 步骤 1️⃣: 登录Leaflow平台
1. 打开浏览器访问Leaflow控制台
2. 使用你的账号登录

### 步骤 2️⃣: 创建新应用
1. **点击"创建应用"**或**"新建应用"**按钮
2. **选择部署方式**:
   - ✅ 选择 "容器部署" 或 "Docker容器"
   - ✅ 选择 "自定义镜像"

### 步骤 3️⃣: 配置镜像信息
**镜像地址**:
```
ghcr.io/baibiao258/daka5gg:latest
```

**或者使用版本标签** (推荐):
```
ghcr.io/baibiao258/daka5gg:v1
```

**注意**:
- 如果看到拉取失败，请检查镜像是否设置为公开
- 或者尝试使用具体的版本标签而非latest

---

## ⚙️ 环境变量配置

### 必需的环境变量

| 变量名 | 示例值 | 说明 |
|--------|--------|------|
| `CHECKIN_USERNAME` | `your_username` | 登录用户名 |
| `CHECKIN_PASSWORD` | `your_password` | 登录密码 |
| `GITHUB_ACTIONS` | `true` | **强制设置**，表示容器环境 |

### 配置步骤
1. **在应用配置页面找到"环境变量"部分**
2. **逐个添加以上变量**:
   - 点击"添加变量"
   - 输入变量名和对应值
   - 保存设置

### 🔒 安全建议
- **敏感信息保护**: 使用Leaflow的密钥管理功能
- **密码加密**: 将密码等敏感信息设置为加密变量
- **权限控制**: 确保只有必要的人员可以查看这些变量

---

## 💻 资源配置

### CPU限制
- **推荐值**: `500m` - `1000m`
- **说明**: 0.5-1个CPU核心
- **设置方式**: 在资源配置页面设置CPU上限

### 内存限制  
- **最小要求**: `1024 MiB` (1GB)
- **推荐值**: `1536 MiB` (1.5GB)
- **说明**: Playwright浏览器需要至少1GB内存
- **设置方式**: 在资源配置页面设置内存上限

### 存储配置 (可选)
- **临时存储**: `5GB` (用于日志和临时文件)
- **挂载路径**: `/app` (如果需要持久化存储)

---

## 🔧 启动配置

### 启动命令
**无需设置**，使用镜像内置命令:
```
python main.py
```

### 健康检查
- **状态**: 自动监控容器状态
- **重启策略**: 设置为"失败时自动重启"
- **启动超时**: 300秒 (5分钟)

### 网络配置
- **端口**: 无需暴露外部端口
- **说明**: 容器内部定时执行，无需外部访问

---

## 📊 部署验证

### 启动后检查
1. **容器状态**: 确认容器正常运行（绿色状态）
2. **查看日志**: 进入"日志"页面查看启动信息
3. **预期日志内容**:
   ```
   🚀 Leaflow 自动化容器启动
   启动时间: 2024-12-04 11:30:00
   时区: ('CST', 'CST')
   用户名: your_username
   
   📅 配置定时任务:
     ✓ 任务 A: 每天 08:00 和 17:00 执行自动打卡
     ✓ 任务 B: 每天 19:00 执行自动日报
   
   ✅ 定时任务配置完成，容器将保持常驻运行
   ⏰ 开始监听定时任务...
   ```

### 功能验证
1. **立即测试**: 可以手动触发任务（如果有手动触发选项）
2. **等待定时任务**: 观察指定时间是否有日志输出
3. **检查结果**: 确认打卡和日报操作是否成功执行

---

## ⏰ 定时任务说明

### 自动打卡
- **执行时间**: 每天 08:00 和 17:00 (北京时间)
- **脚本**: `auto_checkin.py`
- **功能**: 自动登录并完成打卡

### 自动日报
- **执行时间**: 每天 19:00 (北京时间)
- **脚本**: `auto_daily_report.py`
- **功能**: 自动生成并提交工作日报

### 时区设置
- **容器时区**: Asia/Shanghai (北京时间)
- **自动适配**: 无需手动设置时区

---

## 🛠️ 故障排查

### ❌ 容器启动失败

**常见原因**:
1. **环境变量缺失**: CHECKIN_USERNAME 或 CHECKIN_PASSWORD 未设置
2. **镜像拉取失败**: 网络问题或镜像私有化
3. **资源不足**: 内存小于1024MiB

**解决方案**:
1. 检查所有必需的环境变量是否已正确设置
2. 确认镜像地址是否正确，必要时设置为公开
3. 将内存限制提升至至少1024MiB

### ❌ 任务执行失败

**检查项目**:
1. **登录失败**: 确认用户名密码正确
2. **网络问题**: 确认目标网站可访问
3. **验证码问题**: 系统会自动重试，通常能解决

**查看日志**:
- 进入Leaflow控制台 → 应用详情 → 日志
- 搜索 "ERROR" 或 "❌" 关键词
- 查看具体错误信息进行针对性解决

### ❌ 内存不足 (OOM)

**表现**: 容器频繁重启或被Kill

**解决方案**:
1. **增加内存限制**: 提升到 1536MiB 或 2048MiB
2. **检查资源监控**: 在日志中查看内存使用情况
3. **优化配置**: 确认Playwright配置是否合理

---

## 📱 监控和维护

### 日志管理
1. **定期查看**: 建议每天检查一次日志
2. **错误监控**: 关注失败的执行记录
3. **性能监控**: 监控CPU和内存使用情况

### 更新策略
1. **版本升级**: 推送新代码时会自动构建新版本镜像
2. **镜像切换**: 可在Leaflow中更换镜像版本
3. **回滚方案**: 如有问题可快速切换到前一版本

### 备份建议
1. **配置备份**: 定期导出应用配置
2. **日志备份**: 重要日志建议本地保存
3. **凭据管理**: 确保登录凭据的安全存储

---

## 🎯 最佳实践

### ✅ 推荐做法
- **使用版本标签**: 避免使用latest标签
- **定期监控**: 建立日志检查习惯
- **资源充足**: 给容器分配足够的CPU和内存
- **安全第一**: 妥善管理环境变量中的敏感信息

### ❌ 避免做法
- **不要修改镜像内部配置**
- **不要在容器中手动运行命令**
- **不要忽略错误日志**
- **不要使用不足的资源配置**

---

## 📞 获取帮助

### 官方资源
- **Leaflow文档**: https://docs.leaflow.com
- **支持中心**: 联系Leaflow官方支持

### 项目资源
- **GitHub仓库**: https://github.com/baibiao258/daka5gg
- **项目文档**: 查看项目中的README和相关指南

### 社区支持
- **问题反馈**: 在GitHub仓库提交Issue
- **功能建议**: 欢迎提交改进建议

---

## ✅ 部署成功检查清单

部署完成后，请确认以下项目：

- [ ] 容器状态正常（绿色）
- [ ] 启动日志显示定时任务配置成功
- [ ] 环境变量全部设置正确
- [ ] 资源配置符合要求（CPU≥500m，内存≥1024MiB）
- [ ] 能够看到定时任务监听日志
- [ ] 手动测试功能正常（如有需要）

**恭喜！你的自动打卡与日报系统现在已在Leaflow上运行！** 🎉